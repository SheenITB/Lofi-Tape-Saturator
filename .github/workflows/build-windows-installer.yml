name: Build Windows VST3 Installer

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-windows-installer:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Initialize submodules
      shell: pwsh
      run: |
        Write-Host "=== Initializing iPlug2 submodule ==="
        git submodule update --init --recursive
        
        if (Test-Path "iPlug2\IPlug\VST3\IPlugVST3_ProcessorBase.cpp") {
          Write-Host "✓ iPlug2 submodule initialized correctly"
        } else {
          Write-Host "✗ ERROR: iPlug2 files not found"
          exit 1
        }
    
    - name: Clone VST3 SDK
      shell: pwsh
      run: |
        Write-Host "Removing any existing VST3_SDK..."
        Remove-Item -Path "iPlug2\Dependencies\IPlug\VST3_SDK" -Recurse -Force -ErrorAction SilentlyContinue
        
        Write-Host "Cloning VST3 SDK..."
        git clone --depth 1 --branch v3.7.7_build_19 --recurse-submodules https://github.com/steinbergmedia/vst3sdk.git "iPlug2\Dependencies\IPlug\VST3_SDK"
        
        if ($LASTEXITCODE -ne 0) {
          Write-Host "Clone failed!"
          exit 1
        }
        Write-Host "✓ VST3 SDK cloned successfully"
    
    - name: Move to Examples
      shell: pwsh
      run: |
        Write-Host "Preparing Examples directory..."
        
        # Remove old IPlugWebUI example to preserve our config
        if (Test-Path "iPlug2\Examples\IPlugWebUI") {
          Write-Host "Removing old IPlugWebUI example..."
          Remove-Item "iPlug2\Examples\IPlugWebUI" -Recurse -Force
        }
        
        if (-not (Test-Path "iPlug2\Examples")) {
          New-Item -ItemType Directory -Path "iPlug2\Examples" -Force
        }
        
        Write-Host "Moving our IPlugWebUI to Examples..."
        Move-Item "IPlugWebUI" "iPlug2\Examples\IPlugWebUI" -Force
        
        # Verify plugin name
        $plugName = Select-String -Path "iPlug2\Examples\IPlugWebUI\config.h" -Pattern 'PLUG_NAME "(.+)"' | ForEach-Object { $_.Matches.Groups[1].Value }
        Write-Host "✓ Plugin name: $plugName"
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.3
    
    - name: Setup NuGet
      uses: nuget/setup-nuget@v1
    
    - name: Restore NuGet Packages
      shell: pwsh
      run: |
        nuget restore "iPlug2\Examples\IPlugWebUI\Lofi Tape Saturator.sln"
    
    - name: Build VST3 x64
      shell: pwsh
      run: |
        Write-Host "=== Building VST3 x64 Release ==="
        
        # Get absolute path to iPlug2
        $iplug2Root = Resolve-Path "iPlug2"
        Write-Host "IPLUG2_ROOT: $iplug2Root"
        
        # Pass IPLUG2_ROOT as MSBuild property
        msbuild "iPlug2\Examples\IPlugWebUI\Lofi Tape Saturator.sln" `
          /p:Configuration=Release `
          /p:Platform=x64 `
          /p:IPLUG2_ROOT="$iplug2Root" `
          /t:LofiTapeSaturator-vst3 `
          /m `
          /v:minimal
        
        if ($LASTEXITCODE -ne 0) {
          Write-Host "ERROR: Build failed!"
          exit 1
        }
        
        Write-Host "✓ Build completed successfully"
    
    - name: Clean and Rename VST3 Bundle
      shell: pwsh
      run: |
        Write-Host "=== Cleaning and Renaming VST3 Bundle ==="
        
        # Find the built VST3 bundle
        $vst3 = Get-ChildItem -Path "iPlug2\Examples\IPlugWebUI\build-win" -Recurse -Filter "*.vst3" -Directory | Select-Object -First 1
        
        if (-not $vst3) {
          Write-Host "✗ VST3 bundle not found!"
          exit 1
        }
        
        Write-Host "Found VST3: $($vst3.Name)"
        
        # Remove macOS metadata files
        Write-Host "Removing macOS metadata files..."
        Get-ChildItem -Path $vst3.FullName -Recurse -Force -Filter "._*" | Remove-Item -Force -ErrorAction SilentlyContinue
        Get-ChildItem -Path $vst3.FullName -Recurse -Force -Filter ".DS_Store" | Remove-Item -Force -ErrorAction SilentlyContinue
        
        $correctName = "Lofi Tape Saturator.vst3"
        if ($vst3.Name -ne $correctName) {
          $newPath = Join-Path $vst3.Parent.FullName $correctName
          Write-Host "Renaming to: $correctName"
          Move-Item $vst3.FullName $newPath -Force
          Write-Host "✓ Renamed successfully"
        } else {
          Write-Host "✓ Name already correct"
        }
    
    - name: Copy Web Resources
      shell: pwsh
      run: |
        Write-Host "=== Copying Web Resources into VST3 ==="
        
        $vst3 = Get-ChildItem -Path "iPlug2\Examples\IPlugWebUI\build-win" -Recurse -Filter "*.vst3" -Directory | Select-Object -First 1
        
        if (-not $vst3) {
          Write-Host "✗ VST3 bundle not found!"
          exit 1
        }
        
        Write-Host "VST3 bundle: $($vst3.Name)"
        
        # Source web resources
        $webSource = "iPlug2\Examples\IPlugWebUI\resources\web"
        
        if (-not (Test-Path $webSource)) {
          Write-Host "✗ ERROR: Web resources not found at: $webSource"
          exit 1
        }
        
        # Destination inside VST3 bundle
        $webDest = Join-Path $vst3.FullName "Contents\Resources\web"
        
        Write-Host "Creating Resources directory at: $webDest"
        New-Item -ItemType Directory -Path $webDest -Force | Out-Null
        
        Write-Host "Copying web files..."
        Copy-Item "$webSource\*" $webDest -Recurse -Force
        
        Write-Host "✓ Web resources copied successfully"
    
    - name: Prepare Artifacts for Installer
      shell: pwsh
      run: |
        Write-Host "=== Preparing Artifacts ==="
        
        # Create artifacts directory
        New-Item -ItemType Directory -Path "artifacts" -Force | Out-Null
        
        # Find and copy VST3
        $vst3 = Get-ChildItem -Path "iPlug2\Examples\IPlugWebUI\build-win" -Recurse -Filter "*.vst3" -Directory | Select-Object -First 1
        
        if ($vst3) {
          Write-Host "Copying VST3 to artifacts..."
          Copy-Item $vst3.FullName "artifacts\" -Recurse
          Write-Host "✓ VST3 copied"
        } else {
          Write-Host "✗ VST3 not found!"
          exit 1
        }
        
        # List artifacts
        Write-Host "`nArtifacts directory contents:"
        Get-ChildItem "artifacts\" -Recurse | ForEach-Object { Write-Host "  $($_.FullName)" }
    
    - name: Create Placeholder Icon
      shell: pwsh
      run: |
        Write-Host "=== Creating Placeholder Icon ==="
        
        # Check if icon exists
        if (-not (Test-Path "IPlugWebUI\resources\icon.ico")) {
          Write-Host "Creating placeholder icon..."
          # This is just a placeholder - you should replace with actual icon
          New-Item -ItemType Directory -Path "IPlugWebUI\resources" -Force | Out-Null
          
          # For now, we'll use a Windows default icon path as fallback in the installer
          Write-Host "⚠ Warning: No custom icon found. Installer will use default icon."
        } else {
          Write-Host "✓ Icon file found"
        }
    
    - name: Install Inno Setup
      shell: pwsh
      run: |
        Write-Host "=== Installing Inno Setup ==="
        
        # Download Inno Setup
        $innoUrl = "https://jrsoftware.org/download.php/is.exe"
        $innoInstaller = "$env:TEMP\innosetup.exe"
        
        Write-Host "Downloading Inno Setup..."
        Invoke-WebRequest -Uri $innoUrl -OutFile $innoInstaller
        
        Write-Host "Installing Inno Setup..."
        Start-Process -FilePath $innoInstaller -Args "/VERYSILENT /SUPPRESSMSGBOXES /NORESTART /SP-" -Wait
        
        # Add Inno Setup to PATH
        $innoPath = "C:\Program Files (x86)\Inno Setup 6"
        if (Test-Path $innoPath) {
          Write-Host "✓ Inno Setup installed at: $innoPath"
          echo "$innoPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        } else {
          Write-Host "✗ Inno Setup installation failed!"
          exit 1
        }
    
    
    - name: Build Installer
      shell: pwsh
      run: |
        Write-Host "=== Building Installer with Inno Setup ==="
        
        $scriptPath = "installer\windows\setup.iss"
        
        if (-not (Test-Path $scriptPath)) {
          Write-Host "✗ Installer script not found at: $scriptPath"
          exit 1
        }
        
        # Ensure output directory exists
        New-Item -ItemType Directory -Path "artifacts\installer" -Force | Out-Null
        
        # Compile the installer
        $iscc = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
        
        Write-Host "Compiling installer..."
        & $iscc $scriptPath
        
        if ($LASTEXITCODE -ne 0) {
          Write-Host "✗ Installer compilation failed!"
          exit 1
        }
        
        Write-Host "✓ Installer built successfully"
        
        # List installer files
        Write-Host "`nInstaller files:"
        Get-ChildItem "artifacts\installer\" | ForEach-Object { Write-Host "  $($_.Name)" }
    
    - name: Upload VST3 Bundle
      uses: actions/upload-artifact@v4
      with:
        name: LofiTapeSaturator-VST3-Windows-x64
        path: artifacts/Lofi Tape Saturator.vst3
        retention-days: 90
    
    - name: Upload Installer
      uses: actions/upload-artifact@v4
      with:
        name: LofiTapeSaturator-Installer-Windows-x64
        path: artifacts/installer/*.exe
        retention-days: 90
    
    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          artifacts/installer/*.exe
        body: |
          # Lofi Tape Saturator ${{ github.ref_name }}
          
          ## Windows x64 VST3 Plugin
          
          ### Installation Instructions:
          1. Download the installer: `LofiTapeSaturator-*-Windows-x64-Setup.exe`
          2. Run the installer as Administrator
          3. Follow the installation wizard
          4. Restart your DAW (FL Studio, Ableton, etc.)
          5. The plugin will appear in your VST3 plugin list
          
          ### What's Installed:
          - VST3 plugin in `C:\Program Files\Common Files\VST3\`
          - FL Studio integration (if FL Studio is detected)
          - User Documents VST3 folder
          
          ### Requirements:
          - Windows 10 or later (64-bit)
          - VST3-compatible DAW
          
          ### Support:
          For issues or questions, visit: https://www.itbblog.com
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
