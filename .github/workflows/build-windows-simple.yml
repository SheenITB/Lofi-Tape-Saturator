name: Build Windows VST3

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Initialize submodules
      shell: pwsh
      run: |
        Write-Host "=== Initializing iPlug2 submodule ==="
        git submodule update --init --recursive
        
        if (Test-Path "iPlug2\IPlug\VST3\IPlugVST3_ProcessorBase.cpp") {
          Write-Host "✓ iPlug2 submodule initialized correctly"
        } else {
          Write-Host "✗ ERROR: iPlug2 files not found"
          exit 1
        }
    
    - name: Clone VST3 SDK
      shell: pwsh
      run: |
        Write-Host "Removing any existing VST3_SDK..."
        Remove-Item -Path "iPlug2\Dependencies\IPlug\VST3_SDK" -Recurse -Force -ErrorAction SilentlyContinue
        
        Write-Host "Cloning VST3 SDK..."
        git clone --depth 1 --branch v3.7.7_build_19 --recurse-submodules https://github.com/steinbergmedia/vst3sdk.git "iPlug2\Dependencies\IPlug\VST3_SDK"
        
        if ($LASTEXITCODE -ne 0) {
          Write-Host "Clone failed!"
          exit 1
        }
        Write-Host "✓ VST3 SDK cloned successfully"
    
    - name: Move to Examples
      shell: pwsh
      run: |
        Write-Host "Preparing Examples directory..."
        
        # Remove old IPlugWebUI example to preserve our config
        if (Test-Path "iPlug2\Examples\IPlugWebUI") {
          Write-Host "Removing old IPlugWebUI example..."
          Remove-Item "iPlug2\Examples\IPlugWebUI" -Recurse -Force
        }
        
        if (-not (Test-Path "iPlug2\Examples")) {
          New-Item -ItemType Directory -Path "iPlug2\Examples" -Force
        }
        
        Write-Host "Moving our IPlugWebUI to Examples..."
        Move-Item "IPlugWebUI" "iPlug2\Examples\IPlugWebUI" -Force
        
        # Verify plugin name
        $plugName = Select-String -Path "iPlug2\Examples\IPlugWebUI\config.h" -Pattern 'PLUG_NAME "(.+)"' | ForEach-Object { $_.Matches.Groups[1].Value }
        Write-Host "✓ Plugin name: $plugName"
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.3
    
    - name: Setup NuGet
      uses: nuget/setup-nuget@v1
    
    - name: Restore NuGet Packages
      shell: pwsh
      run: |
        nuget restore "iPlug2\Examples\IPlugWebUI\Lofi Tape Saturator.sln"
    
    - name: Build VST3 x64
      shell: pwsh
      run: |
        Write-Host "=== Building VST3 x64 Release ==="
        
        # Get absolute path to iPlug2
        $iplug2Root = Resolve-Path "iPlug2"
        Write-Host "IPLUG2_ROOT: $iplug2Root"
        
        # Pass IPLUG2_ROOT as MSBuild property
        msbuild "iPlug2\Examples\IPlugWebUI\Lofi Tape Saturator.sln" `
          /p:Configuration=Release `
          /p:Platform=x64 `
          /p:IPLUG2_ROOT="$iplug2Root" `
          /t:LofiTapeSaturator-vst3 `
          /m `
          /v:minimal
        
        if ($LASTEXITCODE -ne 0) {
          Write-Host "ERROR: Build failed!"
          exit 1
        }
        
        Write-Host "✓ Build completed successfully"
    
    - name: Copy Web Resources
      shell: pwsh
      run: |
        Write-Host "=== Copying Web Resources into VST3 ==="
        
        # Find the built VST3 bundle
        $vst3 = Get-ChildItem -Path "iPlug2\Examples\IPlugWebUI\build-win" -Recurse -Filter "*.vst3" -Directory | Select-Object -First 1
        
        if (-not $vst3) {
          Write-Host "✗ VST3 bundle not found!"
          exit 1
        }
        
        Write-Host "VST3 bundle: $($vst3.Name)"
        
        # Source web resources
        $webSource = "iPlug2\Examples\IPlugWebUI\resources\web"
        
        if (-not (Test-Path $webSource)) {
          Write-Host "✗ ERROR: Web resources not found at: $webSource"
          exit 1
        }
        
        # Destination inside VST3 bundle
        $webDest = Join-Path $vst3.FullName "Contents\Resources\web"
        
        Write-Host "Creating Resources directory..."
        New-Item -ItemType Directory -Path $webDest -Force | Out-Null
        
        Write-Host "Copying web files..."
        Copy-Item "$webSource\*" $webDest -Recurse -Force
        
        Write-Host "`n✓ Web resources copied successfully"
    
    - name: Package VST3
      shell: pwsh
      run: |
        Write-Host "=== Packaging VST3 ==="
        $vst3 = Get-ChildItem -Path "iPlug2\Examples\IPlugWebUI\build-win" -Recurse -Filter "*.vst3" -Directory | Select-Object -First 1
        
        if ($vst3) {
          Write-Host "✓ Found VST3: $($vst3.Name)"
          New-Item -ItemType Directory -Path "artifacts" -Force | Out-Null
          Copy-Item $vst3.FullName "artifacts\" -Recurse
          Write-Host "✓ Packaged successfully"
        } else {
          Write-Host "✗ VST3 not found!"
          exit 1
        }
    
    - name: Upload VST3
      uses: actions/upload-artifact@v4
      with:
        name: LofiTapeSaturator-VST3-Windows-x64
        path: artifacts/
        retention-days: 90
