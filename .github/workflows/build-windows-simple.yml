name: Build Windows VST3

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive

    - name: "Debug: list repo root and iPlug2 contents"
      shell: pwsh
      run: |
        Write-Host "Workspace root: $env:GITHUB_WORKSPACE"
        Write-Host "List repo root:"
        Get-ChildItem -Force $env:GITHUB_WORKSPACE | Select-Object Name,Mode
        Write-Host "`nList iPlug2 (if present):"
        $iplug2 = Join-Path $env:GITHUB_WORKSPACE 'iPlug2'
        if (Test-Path $iplug2) { Get-ChildItem -Force $iplug2 | Select-Object Name,Mode } else { Write-Host "iPlug2 not checked out" }
        Write-Host "`nList iPlug2\Dependencies (if present):"
        $deps = Join-Path $iplug2 'Dependencies'
        if (Test-Path $deps) { Get-ChildItem -Force $deps | Select-Object Name,Mode } else { Write-Host "iPlug2\Dependencies not present" }

    - name: Ensure VST3 SDK present in iPlug2/Dependencies/IPlug/VST3_SDK
      shell: pwsh
      run: |
        $target = Join-Path $env:GITHUB_WORKSPACE 'iPlug2\Dependencies\IPlug\VST3_SDK'
        Write-Host "VST3 SDK target path: $target"
        if (-Not (Test-Path $target)) {
          Write-Host "Cloning VST3 SDK to $target ..."
          git clone --depth 1 --branch v3.7.7_build_19 --recurse-submodules https://github.com/steinbergmedia/vst3sdk.git $target
          if ($LASTEXITCODE -ne 0) { Write-Error "Git clone failed"; exit 1 }
        } else {
          Write-Host "VST3 SDK already present"
        }
        if (-Not (Test-Path (Join-Path $target 'base'))) { Write-Error "VST3 SDK missing 'base' directory after clone"; exit 1 }

    - name: Initialize submodules
      shell: pwsh
      run: |
        Write-Host "=== Initializing iPlug2 submodule ==="
        git submodule update --init --recursive
        
        if (Test-Path "iPlug2\IPlug\VST3\IPlugVST3_ProcessorBase.cpp") {
          Write-Host "✓ iPlug2 submodule initialized correctly"
        } else {
          Write-Host "✗ ERROR: iPlug2 files not found"
          exit 1
        }
    
    - name: Clone VST3 SDK
      shell: pwsh
      run: |
        Write-Host "Removing any existing VST3_SDK..."
        Remove-Item -Path "iPlug2\Dependencies\IPlug\VST3_SDK" -Recurse -Force -ErrorAction SilentlyContinue
        
        Write-Host "Cloning VST3 SDK..."
        git clone --depth 1 --branch v3.7.7_build_19 --recurse-submodules https://github.com/steinbergmedia/vst3sdk.git "iPlug2\Dependencies\IPlug\VST3_SDK"
        
        if ($LASTEXITCODE -ne 0) {
          Write-Host "Clone failed!"
          exit 1
        }
        Write-Host "✓ VST3 SDK cloned successfully"
    
    - name: Move to Examples
      shell: pwsh
      run: |
        Write-Host "Preparing Examples directory..."
        
        # Remove old IPlugWebUI example to preserve our config
        if (Test-Path "iPlug2\Examples\IPlugWebUI") {
          Write-Host "Removing old IPlugWebUI example..."
          Remove-Item "iPlug2\Examples\IPlugWebUI" -Recurse -Force
        }
        
        if (-not (Test-Path "iPlug2\Examples")) {
          New-Item -ItemType Directory -Path "iPlug2\Examples" -Force
        }
        
        Write-Host "Moving our IPlugWebUI to Examples..."
        Move-Item "IPlugWebUI" "iPlug2\Examples\IPlugWebUI" -Force
        
        # Verify plugin name
        $plugName = Select-String -Path "iPlug2\Examples\IPlugWebUI\config.h" -Pattern 'PLUG_NAME "(.+)"' | ForEach-Object { $_.Matches.Groups[1].Value }
        Write-Host "✓ Plugin name: $plugName"
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.3
    
    - name: Setup NuGet
      uses: nuget/setup-nuget@v1
    
    - name: Restore NuGet Packages
      shell: pwsh
      run: |
        nuget restore "iPlug2\Examples\IPlugWebUI\Lofi Tape Saturator.sln"
    
    - name: Build VST3 x64
      shell: pwsh
      run: |
        Write-Host "=== Building VST3 x64 Release ==="
        
        # Get absolute path to iPlug2
        $iplug2Root = Resolve-Path "iPlug2"
        Write-Host "IPLUG2_ROOT: $iplug2Root"
        
        # Pass IPLUG2_ROOT as MSBuild property
        msbuild "iPlug2\Examples\IPlugWebUI\Lofi Tape Saturator.sln" `
          /p:Configuration=Release `
          /p:Platform=x64 `
          /p:IPLUG2_ROOT="$iplug2Root" `
          /t:LofiTapeSaturator-vst3 `
          /m `
          /v:minimal
        
        if ($LASTEXITCODE -ne 0) {
          Write-Host "ERROR: Build failed!"
          exit 1
        }
        
        Write-Host "✓ Build completed successfully"
    
    - name: Rename VST3 Bundle and Clean macOS Files
      shell: pwsh
      run: |
        Write-Host "=== Cleaning and Renaming VST3 Bundle ==="
        
        # Find the built VST3 bundle
        $vst3 = Get-ChildItem -Path "iPlug2\Examples\IPlugWebUI\build-win" -Recurse -Filter "*.vst3" -Directory | Select-Object -First 1
        
        if (-not $vst3) {
          Write-Host "✗ VST3 bundle not found!"
          exit 1
        }
        
        Write-Host "Found VST3: $($vst3.Name)"
        
        # Remove macOS metadata files (._* files)
        Write-Host "Removing macOS metadata files..."
        Get-ChildItem -Path $vst3.FullName -Recurse -Force -Filter "._*" | Remove-Item -Force
        Get-ChildItem -Path $vst3.FullName -Recurse -Force -Filter ".DS_Store" | Remove-Item -Force
        
        $correctName = "Lofi Tape Saturator.vst3"
        if ($vst3.Name -ne $correctName) {
          $newPath = Join-Path $vst3.Parent.FullName $correctName
          Write-Host "Renaming to: $correctName"
          Move-Item $vst3.FullName $newPath -Force
          Write-Host "✓ Renamed successfully"
        } else {
          Write-Host "✓ Name already correct"
        }
    
    - name: Copy Web Resources
      shell: pwsh
      run: |
        Write-Host "=== Copying Web Resources into VST3 ==="
        
        # Find the built VST3 bundle
        Write-Host "Searching for VST3 bundle in build-win..."
        Get-ChildItem -Path "iPlug2\Examples\IPlugWebUI\build-win" -Recurse | Where-Object { $_.PSIsContainer } | ForEach-Object { Write-Host "  Found: $($_.FullName)" }
        
        $vst3 = Get-ChildItem -Path "iPlug2\Examples\IPlugWebUI\build-win" -Recurse -Filter "*.vst3" -Directory | Select-Object -First 1
        
        if (-not $vst3) {
          Write-Host "✗ VST3 bundle not found!"
          exit 1
        }
        
        Write-Host "VST3 bundle: $($vst3.Name)"
        Write-Host "VST3 path: $($vst3.FullName)"
        
        # Source web resources
        $webSource = "iPlug2\Examples\IPlugWebUI\resources\web"
        
        if (-not (Test-Path $webSource)) {
          Write-Host "✗ ERROR: Web resources not found at: $webSource"
          exit 1
        }
        
        Write-Host "Web source contains:"
        Get-ChildItem $webSource -Recurse | ForEach-Object { Write-Host "  $($_.FullName)" }
        
        # Destination inside VST3 bundle
        $webDest = Join-Path $vst3.FullName "Contents\Resources\web"
        
        Write-Host "Creating Resources directory at: $webDest"
        New-Item -ItemType Directory -Path $webDest -Force | Out-Null
        
        Write-Host "Copying web files..."
        Copy-Item "$webSource\*" $webDest -Recurse -Force
        
        Write-Host "`n✓ Web resources copied successfully"
        Write-Host "Final structure:"
        Get-ChildItem $vst3.FullName -Recurse | ForEach-Object { Write-Host "  $($_.FullName)" }
    
    - name: Package VST3
      shell: pwsh
      run: |
        Write-Host "=== Packaging VST3 ==="
        $vst3 = Get-ChildItem -Path "iPlug2\Examples\IPlugWebUI\build-win" -Recurse -Filter "*.vst3" -Directory | Select-Object -First 1
        
        if ($vst3) {
          Write-Host "✓ Found VST3: $($vst3.Name)"
          New-Item -ItemType Directory -Path "artifacts" -Force | Out-Null
          Copy-Item $vst3.FullName "artifacts\" -Recurse
          Write-Host "✓ Packaged successfully"
        } else {
          Write-Host "✗ VST3 not found!"
          exit 1
        }
    
    - name: Download WebView2 Bootstrapper
      shell: pwsh
      run: |
        Write-Host "=== Downloading WebView2 Bootstrapper ==="
        $webView2Url = "https://go.microsoft.com/fwlink/p/?LinkId=2124703"
        $webView2Path = "installer\windows\MicrosoftEdgeWebview2Setup.exe"
        
        Write-Host "Downloading WebView2 Runtime Bootstrapper..."
        Invoke-WebRequest -Uri $webView2Url -OutFile $webView2Path
        
        if (Test-Path $webView2Path) {
          $size = (Get-Item $webView2Path).Length / 1MB
          Write-Host "✓ Downloaded WebView2 Bootstrapper: $size MB"
        } else {
          Write-Host "✗ Failed to download WebView2 Bootstrapper"
          exit 1
        }

    - name: Setup Inno Setup
      shell: pwsh
      run: |
        Write-Host "=== Setting up Inno Setup ==="
        $innoUrl = "https://jrsoftware.org/download.php/is.exe"
        $innoPath = "$env:TEMP\inno-setup.exe"
        
        Write-Host "Downloading Inno Setup..."
        Invoke-WebRequest -Uri $innoUrl -OutFile $innoPath
        
        Write-Host "Installing Inno Setup..."
        Start-Process -FilePath $innoPath -ArgumentList "/VERYSILENT /SUPPRESSMSGBOXES /NORESTART /DIR=C:\InnoSetup" -Wait
        
        # Add to PATH
        $env:PATH += ";C:\InnoSetup"
        
        # Verify installation
        if (Get-Command "ISCC.exe" -ErrorAction SilentlyContinue) {
          Write-Host "✓ Inno Setup installed successfully"
          ISCC.exe /? | Select-Object -First 5
        } else {
          Write-Host "✗ Inno Setup installation failed"
          exit 1
        }

    - name: Build Installer
      shell: pwsh
      run: |
        Write-Host "=== Building Installer ==="
        
        # Read version from config.h
        $version = Select-String -Path "iPlug2\Examples\IPlugWebUI\config.h" -Pattern 'PLUG_VERSION_STR "(.+)"' | ForEach-Object { $_.Matches.Groups[1].Value }
        if (-not $version) { $version = "1.0.9" }
        Write-Host "Plugin version: $version"
        
        # Create installer output directory
        New-Item -ItemType Directory -Path "artifacts\installer" -Force | Out-Null
        
        # Build the installer with version parameter
        $issPath = "installer\windows\setup.iss"
        if (Test-Path $issPath) {
          Write-Host "Building installer from: $issPath"
          & "C:\InnoSetup\ISCC.exe" "/DMyAppVersion=$version" $issPath
          
          if ($LASTEXITCODE -eq 0) {
            Write-Host "✓ Installer built successfully"
            
            # List generated files
            Get-ChildItem "artifacts\installer" -Recurse | ForEach-Object {
              Write-Host "  Generated: $($_.FullName)"
            }
          } else {
            Write-Host "✗ Installer build failed with exit code: $LASTEXITCODE"
            exit 1
          }
        } else {
          Write-Host "✗ Inno Setup script not found: $issPath"
          exit 1
        }

    - name: Upload VST3 Bundle
      uses: actions/upload-artifact@v4
      with:
        name: LofiTapeSaturator-VST3-Windows-x64
        path: artifacts/Lofi Tape Saturator.vst3/
        retention-days: 90

    - name: Upload Installer
      uses: actions/upload-artifact@v4
      with:
        name: LofiTapeSaturator-Installer-Windows-x64
        path: artifacts/installer/
