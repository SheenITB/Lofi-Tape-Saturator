name: Build Windows VST3

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive
    
    - name: Ensure VST3 SDK is present
      shell: pwsh
      run: |
        $target = "$env:GITHUB_WORKSPACE\iPlug2\Dependencies\IPlug\VST3_SDK"
        if (-not (Test-Path $target)) {
          Write-Host "VST3 SDK not found at $target - cloning vst3sdk..."
          New-Item -ItemType Directory -Force -Path (Split-Path $target) | Out-Null
          git clone --depth 1 --branch v3.7.7_build_19 --recurse-submodules https://github.com/steinbergmedia/vst3sdk.git $target
          
          if ($LASTEXITCODE -ne 0) {
            Write-Host "ERROR: Git clone failed!"
            exit 1
          }
        } else {
          Write-Host "VST3 SDK already present at $target"
        }
        
        # Verify structure
        Write-Host "`n=== Verifying VST3 SDK structure ==="
        $requiredDirs = @("base", "public.sdk", "pluginterfaces")
        
        foreach ($dir in $requiredDirs) {
          $fullPath = Join-Path $target $dir
          if (Test-Path $fullPath) {
            Write-Host "✓ $dir"
          } else {
            Write-Host "✗ MISSING: $dir"
            exit 1
          }
        }
        
        # Verify key source files
        $keyFiles = @(
          "base\source\baseiids.cpp",
          "base\source\fdebug.cpp",
          "pluginterfaces\base\funknown.cpp",
          "public.sdk\source\vst\vstaudioeffect.cpp"
        )
        
        Write-Host "`n=== Verifying key source files ==="
        $allFilesExist = $true
        foreach ($file in $keyFiles) {
          $fullPath = Join-Path $target $file
          if (Test-Path $fullPath) {
            Write-Host "✓ $file"
          } else {
            Write-Host "✗ MISSING: $file"
            $allFilesExist = $false
          }
        }
        
        if (-not $allFilesExist) {
          Write-Host "`nERROR: One or more key source files are missing!"
          exit 1
        }
        
        Write-Host "`n✓ VST3 SDK initialized at: $target"
    
    - name: Verify project can find VST3 SDK
      shell: pwsh
      run: |
        Write-Host "=== Testing VST3 SDK path from project directory ==="
        
        # From IPlugWebUI/projects/ the path should be ../../../iPlug2/Dependencies/IPlug/VST3_SDK
        Set-Location "IPlugWebUI\projects"
        
        $relPath = "..\..\..\iPlug2\Dependencies\IPlug\VST3_SDK"
        $absPath = Resolve-Path $relPath -ErrorAction SilentlyContinue
        
        if ($absPath -and (Test-Path "$relPath\base")) {
          Write-Host "✓ VST3 SDK accessible from project: $absPath"
        } else {
          Write-Host "✗ ERROR: VST3 SDK NOT accessible from project directory"
          Write-Host "Expected path: $relPath"
          Write-Host "Current location: $(Get-Location)"
          Write-Host "`nDirectory structure:"
          Get-ChildItem ..\..\.. | Select-Object Name
          exit 1
        }
        
        Set-Location ..\..
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.3
    
    - name: Setup NuGet
      uses: nuget/setup-nuget@v1
    
    - name: Restore NuGet Packages
      shell: pwsh
      run: |
        nuget restore IPlugWebUI\IPlugWebUI.sln
    
    - name: Build VST3
      shell: pwsh
      run: |
        msbuild IPlugWebUI\IPlugWebUI.sln `
          /p:Configuration=Release `
          /p:Platform=x64 `
          /t:IPlugWebUI-vst3 `
          /m `
          /v:minimal
    
    - name: Package VST3
      shell: pwsh
      run: |
        $vst3Path = "IPlugWebUI\build-win\x64\Release\VST3\Lofi Tape Saturator.vst3"
        
        if (Test-Path $vst3Path) {
          New-Item -ItemType Directory -Force -Path artifacts
          Copy-Item $vst3Path artifacts\ -Recurse
          Write-Host "✓ VST3 packaged successfully"
        } else {
          Write-Host "✗ VST3 not found at expected location: $vst3Path"
          Write-Host "Searching for VST3 files..."
          Get-ChildItem -Path "IPlugWebUI\build-win" -Recurse -Filter "*.vst3" -ErrorAction SilentlyContinue
          Write-Host "`nBuild directory structure:"
          Get-ChildItem IPlugWebUI\build-win -Recurse -ErrorAction SilentlyContinue | Select-Object FullName
          exit 1
        }
    
    - name: Upload VST3
      uses: actions/upload-artifact@v4
      with:
        name: LofiTapeSaturator-VST3-Windows-x64
        path: artifacts/Lofi Tape Saturator.vst3/
        retention-days: 90
    
    - name: Debug VST3 SDK path
      if: failure()
      shell: cmd
      run: |
        echo "Listing SDK contents:"
        dir /b /s "%GITHUB_WORKSPACE%\iPlug2\Dependencies\IPlug\VST3_SDK"
