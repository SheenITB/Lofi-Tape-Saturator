name: Build Windows VST3

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout with submodules
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Initialize VST3 SDK in submodule
      shell: pwsh
      run: |
        Write-Host "=== Initializing VST3 SDK ==="
        
        # Navigate to Dependencies/IPlug
        Set-Location iPlug2/Dependencies/IPlug
        
        $vst3Path = "VST3_SDK"
        
        # Always remove and re-clone to ensure fresh SDK
        if (Test-Path $vst3Path) {
          Write-Host "Removing existing VST3_SDK directory..."
          Remove-Item $vst3Path -Recurse -Force -ErrorAction SilentlyContinue
        }
        
        # Clone VST3 SDK
        Write-Host "Cloning VST3 SDK from Steinberg GitHub..."
        git clone --depth 1 --branch v3.7.7_build_19 https://github.com/steinbergmedia/vst3sdk.git $vst3Path
        
        if ($LASTEXITCODE -ne 0) {
          Write-Host "ERROR: Git clone failed!"
          exit 1
        }
        
        Write-Host "✓ VST3 SDK cloned successfully"
        
        # Verify critical directories exist
        $requiredDirs = @(
          "$vst3Path/base",
          "$vst3Path/public.sdk",
          "$vst3Path/pluginterfaces"
        )
        
        $allExist = $true
        foreach ($dir in $requiredDirs) {
          if (Test-Path $dir) {
            Write-Host "✓ Found: $dir"
          } else {
            Write-Host "✗ MISSING: $dir"
            $allExist = $false
          }
        }
        
        if (!$allExist) {
          Write-Host "ERROR: VST3 SDK structure incomplete!"
          Write-Host "Contents of VST3_SDK:"
          Get-ChildItem $vst3Path | Select-Object Name
          exit 1
        }
        
        # List some key source files to verify
        Write-Host "`n=== Verifying key source files ==="
        $keyFiles = @(
          "$vst3Path/base/source/baseiids.cpp",
          "$vst3Path/pluginterfaces/base/funknown.cpp",
          "$vst3Path/public.sdk/source/vst/vstaudioeffect.cpp"
        )
        
        foreach ($file in $keyFiles) {
          if (Test-Path $file) {
            Write-Host "✓ $file"
          } else {
            Write-Host "✗ MISSING: $file"
          }
        }
        
        Write-Host "`n✓ VST3 SDK initialization complete"
        Set-Location ../../..
    
    - name: Move to Examples structure
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path iPlug2/Examples | Out-Null
        Move-Item IPlugWebUI iPlug2/Examples/IPlugWebUI -Force
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.3
    
    - name: Setup NuGet
      uses: nuget/setup-nuget@v1
    
    - name: Restore NuGet Packages
      shell: pwsh
      run: |
        nuget restore iPlug2/Examples/IPlugWebUI/IPlugWebUI.sln
    
    - name: Build VST3 x64
      shell: pwsh
      run: |
        msbuild iPlug2/Examples/IPlugWebUI/IPlugWebUI.sln `
          /p:Configuration=Release `
          /p:Platform=x64 `
          /t:IPlugWebUI-vst3 `
          /m `
          /v:minimal
    
    - name: Package VST3
      shell: pwsh
      run: |
        $vst3Path = "iPlug2/Examples/IPlugWebUI/build-win/x64/Release/VST3/Lofi Tape Saturator.vst3"
        
        if (Test-Path $vst3Path) {
          New-Item -ItemType Directory -Force -Path artifacts
          Copy-Item $vst3Path artifacts/ -Recurse
          Write-Host "✓ VST3 packaged successfully"
        } else {
          Write-Host "✗ VST3 not found at expected location"
          Write-Host "Searching for VST3 files..."
          Get-ChildItem -Path "iPlug2/Examples/IPlugWebUI/build-win" -Recurse -Filter "*.vst3"
          exit 1
        }
    
    - name: Upload VST3
      uses: actions/upload-artifact@v4
      with:
        name: LofiTapeSaturator-VST3-Windows-x64
        path: artifacts/Lofi Tape Saturator.vst3/
        retention-days: 90
