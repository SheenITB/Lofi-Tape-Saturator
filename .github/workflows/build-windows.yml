name: Build VST3 Windows

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Permette build manuale

jobs:
  build-windows:
    runs-on: windows-latest
    
    strategy:
      matrix:
        platform: [x64]
        configuration: [Release]
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'
        fetch-depth: 1
    
    - name: Ensure Dependencies/IPlug directory exists
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path Dependencies\IPlug

    - name: Download VST3 SDK
      shell: pwsh
      run: |
        if (-not (Test-Path Dependencies\IPlug\VST3_SDK)) {
          git clone --depth 1 --recurse-submodules https://github.com/steinbergmedia/vst3sdk.git Dependencies\IPlug\VST3_SDK
        } else {
          Write-Host "VST3_SDK already present"
        }

    - name: Initialize VST3 SDK
      run: |
        # Check if VST3_SDK is properly initialized
        $vst3Path = "iPlug2/Dependencies/IPlug/VST3_SDK"
        $needsClone = $true
        
        if (Test-Path "$vst3Path/base/source/fdebug.cpp") {
          Write-Host "✓ VST3_SDK already properly initialized"
          $needsClone = $false
        } elseif (Test-Path $vst3Path) {
          Write-Host "VST3_SDK directory exists but submodules not initialized, removing..."
          Remove-Item $vst3Path -Recurse -Force
        }
        
        if ($needsClone) {
          Write-Host "Cloning VST3 SDK from GitHub with submodules..."
          
          # Ensure parent directory exists
          New-Item -ItemType Directory -Force -Path "iPlug2/Dependencies/IPlug" | Out-Null
          
          # Clone VST3 SDK with submodules initialized
          git clone --depth 1 --recurse-submodules --branch v3.7.7_build_19 https://github.com/steinbergmedia/vst3sdk.git temp_vst3
          
          # Move to correct location
          Move-Item "temp_vst3" $vst3Path -Force
          
          Write-Host "✓ VST3_SDK cloned successfully"
        }
        
        # Final verification - check for actual source files, not just directories
        if (Test-Path "$vst3Path/base/source/fdebug.cpp") {
          Write-Host "✓ VST3_SDK verified - base source files found"
          Get-ChildItem $vst3Path | Select-Object Name | Format-Table -HideTableHeaders
        } else {
          Write-Host "✗ VST3_SDK installation failed - submodules may not be initialized!"
          Write-Host "Contents of VST3_SDK:"
          Get-ChildItem $vst3Path -ErrorAction SilentlyContinue
          Write-Host "Contents of VST3_SDK/base:"
          Get-ChildItem "$vst3Path/base" -ErrorAction SilentlyContinue
          exit 1
        }
    
    - name: Move project to iPlug2/Examples structure
      run: |
        # Create Examples directory if it doesn't exist
        New-Item -ItemType Directory -Force -Path "iPlug2/Examples"
        
        # Move IPlugWebUI into iPlug2/Examples/
        Move-Item -Path "IPlugWebUI" -Destination "iPlug2/Examples/IPlugWebUI" -Force
        
        # Set working directory for subsequent steps
        echo "PROJECT_DIR=${{ github.workspace }}/iPlug2/Examples/IPlugWebUI" >> $env:GITHUB_ENV
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.3
    
    - name: Setup Windows SDK
      uses: GuillaumeFalourd/setup-windows10-sdk-action@v1.11
      with:
        sdk-version: 19041
    
    - name: Restore NuGet Packages
      run: nuget restore iPlug2/Examples/IPlugWebUI/IPlugWebUI.sln
    
    - name: Build VST3 ${{ matrix.platform }}
      run: |
        msbuild iPlug2/Examples/IPlugWebUI/IPlugWebUI.sln `
          /p:Configuration=${{ matrix.configuration }} `
          /p:Platform=${{ matrix.platform }} `
          /t:IPlugWebUI-vst3 `
          /m `
          /v:minimal
    
    - name: Create Artifact Directory
      run: |
        New-Item -ItemType Directory -Force -Path ./artifacts/${{ matrix.platform }}
    
    - name: Copy VST3 Bundle
      run: |
        $vst3Path = "iPlug2/Examples/IPlugWebUI/build-win/${{ matrix.platform }}/${{ matrix.configuration }}/VST3/Lofi Tape Saturator.vst3"
        if (Test-Path $vst3Path) {
          Copy-Item -Path $vst3Path -Destination ./artifacts/${{ matrix.platform }}/ -Recurse -Force
        } else {
          Write-Host "VST3 not found at: $vst3Path"
          Get-ChildItem -Path "iPlug2/Examples/IPlugWebUI/build-win" -Recurse
          exit 1
        }
    
    - name: Upload VST3 ${{ matrix.platform }}
      uses: actions/upload-artifact@v4
      with:
        name: LofiTapeSaturator-VST3-Windows-${{ matrix.platform }}
        path: ./artifacts/${{ matrix.platform }}/Lofi Tape Saturator.vst3/
        retention-days: 90
    
    - name: Create Release Archive
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        Compress-Archive -Path ./artifacts/${{ matrix.platform }}/* `
          -DestinationPath ./LofiTapeSaturator_v1.0.9_Windows_${{ matrix.platform }}_VST3.zip
    
    - name: Upload Release Asset
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: ./LofiTapeSaturator_v1.0.9_Windows_${{ matrix.platform }}_VST3.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
